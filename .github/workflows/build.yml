name: ğŸ”¤ Build Sahel Font

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    name: ğŸ—ï¸ Build Variable Font
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "::group::ğŸ“¦ Installing system dependencies"
        sudo apt-get update
        sudo apt-get install -y fontforge woff2
        echo "::endgroup::"
        
        echo "::group::ğŸ Installing Python dependencies"
        pip install --upgrade pip
        pip install fontmake fonttools brotli zopfli
        echo "::endgroup::"
        
    - name: ğŸ” Verify tools installation
      run: |
        echo "âœ“ FontForge version:"
        fontforge --version 2>&1 | head -n 1 || echo "FontForge installed"
        echo ""
        echo "âœ“ Python version:"
        python3 --version
        echo ""
        echo "âœ“ fontmake version:"
        fontmake --version
        echo ""
        echo "âœ“ woff2_compress available:"
        which woff2_compress
        
    - name: ğŸ—ï¸ Build variable font
      run: |
        cd variable
        chmod +x makevariable.sh
        ./makevariable.sh ../dist
        
    - name: ğŸ” Verify build outputs
      run: |
        echo "ğŸ“‹ Checking for built font files..."
        if [ -f "dist/Sahel-VF.ttf" ]; then
          echo "âœ“ Variable TTF found"
          ls -lh dist/Sahel-VF.ttf
        else
          echo "âœ— Variable TTF not found!"
          exit 1
        fi
        
        if [ -f "dist/Sahel-VF.woff2" ]; then
          echo "âœ“ Variable WOFF2 found"
          ls -lh dist/Sahel-VF.woff2
        else
          echo "âœ— Variable WOFF2 not found!"
          exit 1
        fi
        
        echo ""
        echo "ğŸ“Š Build statistics:"
        echo "  TTF size:   $(du -h dist/Sahel-VF.ttf | cut -f1)"
        echo "  WOFF2 size: $(du -h dist/Sahel-VF.woff2 | cut -f1)"
        
    - name: ğŸ“¦ Upload variable font artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sahel-variable-fonts
        path: |
          dist/Sahel-VF.ttf
          dist/Sahel-VF.woff2
        if-no-files-found: error
        retention-days: 90
        
    - name: ğŸ“¦ Upload all font artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sahel-all-fonts
        path: |
          dist/**/*.ttf
          dist/**/*.woff
          dist/**/*.woff2
          dist/**/*.eot
          dist/**/font-face.css
        if-no-files-found: error
        retention-days: 90
        
  test:
    name: ğŸ§ª Test Font Files
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install fonttools
      run: |
        pip install fonttools
        
    - name: ğŸ“¥ Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: sahel-variable-fonts
        path: dist/
        
    - name: ğŸ§ª Validate TTF font
      run: |
        echo "ğŸ” Validating Sahel-VF.ttf..."
        ttx -l dist/Sahel-VF.ttf
        echo "âœ“ TTF validation passed"
        
    - name: ğŸ§ª Check font metadata
      run: |
        echo "ğŸ“‹ Font metadata:"
        ttx -t name -o - dist/Sahel-VF.ttf | grep -A 2 "namerecord" | head -n 20
        echo "âœ“ Metadata check passed"
        
    - name: âœ… Test summary
      run: |
        echo "âœ“ All font validation tests passed!"
        echo ""
        echo "ğŸ“Š Summary:"
        echo "  - TTF file structure: Valid"
        echo "  - WOFF2 file: Present"
        echo "  - Metadata: Readable"
